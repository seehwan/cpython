# JIT Patching ê³¼ì •ì—ì„œ ìš°ì—°íˆ ìƒì„±ë˜ëŠ” Gadget ë¶„ì„

## ğŸ¯ í•µì‹¬ ì§ˆë¬¸

**"JIT patching ê³¼ì •ì—ì„œ stencil holeì„ ì±„ìš¸ ë•Œ, ìš°ì—°íˆ gadget ë°”ì´íŠ¸ íŒ¨í„´(pop rax, pop rsi, syscall ë“±)ì´ ìƒì„±ë  ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ?"**

ë‹µ: **ê°€ëŠ¥í•˜ì§€ë§Œ ê·¹íˆ ë“œë¬¼ë©°, ì‹¤ìš©ì„±ì´ ì—†ìŒ**

---

## ğŸ“Š Patching ë©”ì»¤ë‹ˆì¦˜ ë¶„ì„

### 1. Stencil Holeì´ë€?

```c
// Tools/jit/_stencils.py
@dataclasses.dataclass
class Hole:
    """
    A "hole" in the stencil to be patched with a computed runtime value.
    Analogous to relocation records in an object file.
    """
    offset: int           # stencil ë‚´ ìœ„ì¹˜
    kind: str            # relocation íƒ€ì…
    value: HoleValue     # íŒ¨ì¹˜í•  ê¸°ë³¸ ê°’
    symbol: str | None   # ì‹¬ë³¼ ì£¼ì†Œ
    addend: int          # ì¶”ê°€ ì˜¤í”„ì…‹
```

**Holeì˜ ìš©ë„**:
- í•¨ìˆ˜ í¬ì¸í„° ì£¼ì†Œ íŒ¨ì¹˜
- Jump target ì£¼ì†Œ íŒ¨ì¹˜  
- ìƒìˆ˜ ê°’(oparg, operand) íŒ¨ì¹˜
- GOT(Global Offset Table) ì£¼ì†Œ íŒ¨ì¹˜

### 2. Patch í•¨ìˆ˜ë“¤ (x86-64)

#### ì‹¤ì œ ì‚¬ìš© í˜„í™© (jit_stencils.h ë¶„ì„)
```
í•¨ìˆ˜                    | ì‚¬ìš© íšŸìˆ˜ | ìš©ë„
-----------------------|----------|------------------------------------------
patch_64()             | 7,502íšŒ  | 64ë¹„íŠ¸ ì ˆëŒ€ ì£¼ì†Œ (í¬ì¸í„°, í•¨ìˆ˜ ì£¼ì†Œ)
patch_x86_64_32rx()    | 2,583íšŒ  | 32ë¹„íŠ¸ PC-relative + GOT ìµœì í™”
patch_32r()            | 567íšŒ    | 32ë¹„íŠ¸ PC-relative (jump, call)
```

#### êµ¬í˜„ ìƒì„¸

```c
// Python/jit.c

// ========================================
// 1. patch_64: 64ë¹„íŠ¸ ì ˆëŒ€ ì£¼ì†Œ
// ========================================
void patch_64(unsigned char *location, uint64_t value) {
    *(uint64_t *)location = value;
}

// ìš©ë„:
//   - í•¨ìˆ˜ í¬ì¸í„° (_PyLong_Add, __assert_fail, etc.)
//   - íƒ€ì… ê°ì²´ í¬ì¸í„° (PyLong_Type, PyCode_Type)
//   - ì „ì—­ ë³€ìˆ˜ ì£¼ì†Œ (_Py_stats, _PyEval_BinaryOps)
//   - ë°ì´í„° ì„¹ì…˜ ì£¼ì†Œ (data + offset)
//   - instruction->oparg (ì†Œí˜• ì •ìˆ˜ ê°’)
//
// ë°”ì´íŠ¸ ë¶„í¬:
//   - í•¨ìˆ˜/ì „ì—­ ë³€ìˆ˜ ì£¼ì†Œ: 0x7ffff7000000 ~ 0x7fffffff8000 (libc, shared objects)
//   - ë°ì´í„° ì„¹ì…˜ ìƒëŒ€ ì£¼ì†Œ: ì‘ì€ ì˜¤í”„ì…‹ (<4096)
//   - oparg: 0 ~ 255 ë²”ìœ„
//
// ì˜ˆì‹œ:
//   patch_64(code + 0x3, (uintptr_t)&_Py_stats);              // 0x7ffff7xxxxxx
//   patch_64(code + 0x24, instruction->oparg);                 // 0x00000000000000XX
//   patch_64(code + 0xcd, (uintptr_t)data + 0x16b);            // 0x00007fffxxxxxxxx


// ========================================
// 2. patch_32r: 32ë¹„íŠ¸ PC-relative ì£¼ì†Œ
// ========================================
void patch_32r(unsigned char *location, uint64_t value) {
    value -= (uintptr_t)location;  // ìƒëŒ€ ì˜¤í”„ì…‹ ê³„ì‚°
    // Check: -2^31 <= offset < 2^31
    *(uint32_t *)location = (uint32_t)value;
}

// ìš©ë„:
//   - ì½”ë“œ ì„¹ì…˜ ëìœ¼ë¡œì˜ ì í”„ (epilogue)
//   - ì—ëŸ¬ í•¸ë“¤ëŸ¬ë¡œì˜ ì í”„ (error_target)
//
// ë°”ì´íŠ¸ ë¶„í¬:
//   - ê°™ì€ í•¨ìˆ˜ ë‚´ ìƒëŒ€ ì£¼ì†Œì´ë¯€ë¡œ ì‘ì€ ì˜¤í”„ì…‹
//   - ì¼ë°˜ì ìœ¼ë¡œ -1000 ~ +1000 ë²”ìœ„
//   - ë¶€í˜¸ ìˆëŠ” 32ë¹„íŠ¸ë¡œ í‘œí˜„
//
// ì˜ˆì‹œ:
//   patch_32r(code + 0x13, (uintptr_t)code + sizeof(code_body) - 4);
//   patch_32r(code + 0x1f6, state->instruction_starts[error_target] - 4);


// ========================================
// 3. patch_x86_64_32rx: PC-relative + GOT ìµœì í™”
// ========================================
void patch_x86_64_32rx(unsigned char *location, uint64_t value) {
    // GOT load relaxation ì‹œë„:
    // ë§Œì•½ íƒ€ê²Ÿ ì£¼ì†Œê°€ 32ë¹„íŠ¸ ìƒëŒ€ ë²”ìœ„ ë‚´ë¼ë©´,
    // GOTë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ì§ì ‘ ì ‘ê·¼ìœ¼ë¡œ ìµœì í™”
    
    uint64_t relaxed = *(uint64_t *)(value + 4) - 4;
    if ((int64_t)relaxed - (int64_t)location >= -(1LL << 31) &&
        (int64_t)relaxed - (int64_t)location + 1 < (1LL << 31))
    {
        // ìµœì í™” ê°€ëŠ¥í•œ ê²½ìš° ëª…ë ¹ì–´ ë³€í™˜:
        
        // mov reg, [rip + GOT_offset]  â†’  lea reg, [rip + target]
        if (loc[-2] == 0x8B) {
            loc[-2] = 0x8D;  // mov â†’ lea
            value = relaxed;
        }
        
        // call [rip + GOT_offset]  â†’  nop; call target
        else if (loc[-2] == 0xFF && loc[-1] == 0x15) {
            loc[-2] = 0x90;  // nop
            loc[-1] = 0xE8;  // call
            value = relaxed;
        }
        
        // jmp [rip + GOT_offset]  â†’  nop; jmp target
        else if (loc[-2] == 0xFF && loc[-1] == 0x25) {
            loc[-2] = 0x90;  // nop
            loc[-1] = 0xE9;  // jmp
            value = relaxed;
        }
    }
    
    // ìµœì¢…ì ìœ¼ë¡œ 32ë¹„íŠ¸ ìƒëŒ€ ì£¼ì†Œ íŒ¨ì¹˜
    patch_32r(location, value);
}

// ìš©ë„:
//   - ë°ì´í„° ì„¹ì…˜ GOT ì—”íŠ¸ë¦¬ ì°¸ì¡°
//   - í•¨ìˆ˜ í˜¸ì¶œ ìµœì í™”
//
// ë°”ì´íŠ¸ ë¶„í¬:
//   - GOT ì˜¤í”„ì…‹ ë˜ëŠ” ìµœì í™”ëœ ìƒëŒ€ ì£¼ì†Œ
//   - ì¼ë°˜ì ìœ¼ë¡œ -4096 ~ +4096 ë²”ìœ„
//   - ìµœì í™” ì‹œ ëª…ë ¹ì–´ ë°”ì´íŠ¸ ìì²´ê°€ ë³€ê²½ë¨! (0x8Bâ†’0x8D, 0xFFâ†’0x90)
//
// ì˜ˆì‹œ:
//   patch_x86_64_32rx(code + 0xdf, (uintptr_t)data + 0x2cc);
//   // data ì„¹ì…˜ ì ‘ê·¼, GOT ê±°ì¹˜ì§€ ì•Šê³  ì§ì ‘ ì ‘ê·¼ìœ¼ë¡œ ìµœì í™” ê°€ëŠ¥
```

---

## ğŸ”¬ íŒ¨ì¹˜ íƒ€ì…ë³„ Gadget ìƒì„± ê°€ëŠ¥ì„± ë¶„ì„

### ì‹¤ì œ ì‚¬ìš© íŒ¨í„´ ë¶„ì„

JIT ì½”ë“œì—ì„œ ê° íŒ¨ì¹˜ íƒ€ì…ì´ ì–´ë–¤ ê°’ì„ ì±„ìš°ëŠ”ì§€ í™•ì¸:

```c
// 1. patch_64 - 7,502ê°œ ì‚¬ìš©
patch_64(data + 0x2d0, (uintptr_t)&_Py_NegativeRefcount);     // í•¨ìˆ˜ ì£¼ì†Œ
patch_64(code + 0x24, instruction->oparg);                     // ì‘ì€ ì •ìˆ˜ (0-255)
patch_64(code + 0x31, (uintptr_t)&_PyEval_BinaryOps);         // ì „ì—­ ë³€ìˆ˜ ì£¼ì†Œ
patch_64(code + 0xcd, (uintptr_t)data + 0x16b);                // ë°ì´í„° ì„¹ì…˜ ì£¼ì†Œ

// 2. patch_x86_64_32rx - 2,583ê°œ ì‚¬ìš©
patch_x86_64_32rx(code + 0xdf, (uintptr_t)data + 0x2cc);      // GOT ì—”íŠ¸ë¦¬
patch_x86_64_32rx(code + 0x107, (uintptr_t)data + 0x2d4);     // ë°ì´í„° ì„¹ì…˜

// 3. patch_32r - 567ê°œ ì‚¬ìš©
patch_32r(code + 0x13, (uintptr_t)code + sizeof(code_body) - 4);
patch_32r(code + 0x1f6, state->instruction_starts[error_target] - 4);
```

---

### ğŸ“Š Type 1: patch_64 (8ë°”ì´íŠ¸ ì ˆëŒ€ ì£¼ì†Œ) - **ê°€ì¥ ì¤‘ìš”**

#### íŠ¹ì„±
- **ì‚¬ìš© íšŸìˆ˜**: 7,502ê°œ (ì „ì²´ì˜ 71%)
- **ë°”ì´íŠ¸ í¬ê¸°**: 8ë°”ì´íŠ¸
- **ê°’ ë²”ìœ„**: 
  - í•¨ìˆ˜/ì „ì—­ ì£¼ì†Œ: 0x7ffff7000000 ~ 0x7fffffff8000 (ëŒ€ë¶€ë¶„)
  - ë°ì´í„° ì„¹ì…˜: 0x00007fffxxxxxxxx
  - oparg: 0x0000000000000000 ~ 0x00000000000000FF
- **Unintended ê¸°íšŒ**: 8ê°œ ì˜¤í”„ì…‹

#### Gadget íŒ¨í„´ë³„ í™•ë¥ 

##### 1) pop rax; ret (58 c3)

```
ì˜ˆì‹œ ì£¼ì†Œ: 0x7ffff7a12358

ë©”ëª¨ë¦¬ ë ˆì´ì•„ì›ƒ:
Offset  Bytes               Instruction (aligned)
0:      58 23 a1 f7        (ë¶€ë¶„ì ì¸ ì£¼ì†Œ)
        ^^
        pop rax (0x58)

Offset  Bytes               Instruction (unintended +0)
0:      58                 pop rax       âœ…
1:      23 a1 f7 ff 7f 00  and esp, [rcx+0x7ffff7a1]
```

**í™•ë¥  ê³„ì‚°**:
```
8ë°”ì´íŠ¸ íŒ¨ì¹˜ì—ì„œ:

P(58ì´ ì–´ë”˜ê°€ ì¡´ì¬) = 1 - (255/256)^8 â‰ˆ 3.1%

í•˜ì§€ë§Œ "pop rax; ret"ì„ ìœ„í•´ì„œëŠ”:
- 58 ë‹¤ìŒì— c3ì´ ì™€ì•¼ í•¨
- P(ë‹¤ìŒ ë°”ì´íŠ¸ê°€ c3) = 1/256

í˜„ì‹¤:
- 58ì´ ë“±ì¥í•´ë„, ë‹¤ìŒ ë°”ì´íŠ¸ëŠ” íŒ¨ì¹˜ëœ ì£¼ì†Œì˜ ë‚˜ë¨¸ì§€ ë¶€ë¶„
- ì£¼ì†Œ ë°”ì´íŠ¸ ë¶„í¬ëŠ” ê· ë“±í•˜ì§€ ì•ŠìŒ:
  - í•˜ìœ„ ë°”ì´íŠ¸: ë‹¤ì–‘í•¨ (0x00 ~ 0xff)
  - ì¤‘ê°„ ë°”ì´íŠ¸: 0x7f, 0xf7 ë“±ì´ ë§ìŒ
  - ìƒìœ„ ë°”ì´íŠ¸: 0x00ì´ ëŒ€ë¶€ë¶„

ì‹¤ì œ í™•ë¥ : P(58 ì¡´ì¬) Ã— P(ë‹¤ìŒ=c3) â‰ˆ 3.1% Ã— 0.4% â‰ˆ 0.012%
```

**âŒ ë¬¸ì œì **:
1. **ë‹¤ìŒ ë°”ì´íŠ¸ ì œì–´ ë¶ˆê°€**: 58ì„ ì°¾ì•„ë„, ê·¸ ë‹¤ìŒì€ ì£¼ì†Œì˜ ì¼ë¶€ë¼ c3ì¼ ê°€ëŠ¥ì„± ê·¹íˆ ë‚®ìŒ
2. **ì •í™•í•œ ì˜¤í”„ì…‹ í•„ìš”**: ROP chainì—ì„œ ì •í™•íˆ 58ì´ ìˆëŠ” ë°”ì´íŠ¸ë¡œ ì í”„í•´ì•¼ í•¨

##### 2) pop rsi; ret (5e c3) - ë™ì¼í•œ í™•ë¥ 

```
P(5e ì¡´ì¬ & ë‹¤ìŒ=c3) â‰ˆ 0.012%
```

##### 3) syscall (0f 05) - **ì•½ê°„ ë” ë†’ìŒ**

```
syscallì€ 2ë°”ì´íŠ¸ ì‹œí€€ìŠ¤:
0f 05

8ë°”ì´íŠ¸ íŒ¨ì¹˜ì—ì„œ ì—°ì†ëœ 2ë°”ì´íŠ¸ ë§¤ì¹­:
Position 0: [0f] [05] [XX] [XX] [XX] [XX] [XX] [XX]
Position 1: [XX] [0f] [05] [XX] [XX] [XX] [XX] [XX]
...
Position 6: [XX] [XX] [XX] [XX] [XX] [XX] [0f] [05]

P(íŠ¹ì • 2ë°”ì´íŠ¸ê°€ 0f 05) = 1/65536
7ê°œ ê°€ëŠ¥í•œ ìœ„ì¹˜ Ã— (1/65536) â‰ˆ 0.011%

í•˜ì§€ë§Œ syscallì€ ë‹¨ë…ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥ (ret ë¶ˆí•„ìš”!)
â†’ ì‹¤ìš©ì„± ì•½ê°„ ë” ë†’ìŒ (í•˜ì§€ë§Œ ì—¬ì „íˆ 0.01% ìˆ˜ì¤€)
```

#### ì‹¤ì œ ì˜ˆì‹œ ë¶„ì„

```c
// BINARY_OP ìŠ¤í…ì‹¤ì˜ íŒ¨ì¹˜
patch_64(code + 0x3, (uintptr_t)&_Py_stats);
// _Py_stats ì£¼ì†Œ: 0x00007ffff7dd4560

ë©”ëª¨ë¦¬:
0x3: 60 45 dd f7 ff 7f 00 00

Unintended instruction ìŠ¤ìº”:
Offset 0: 60 45           pusha (invalid in 64-bit)
Offset 1: 45 dd f7        rex.RB unknown
Offset 2: dd f7           unknown
Offset 3: f7 ff           idiv edi
Offset 4: ff 7f 00        push qword ptr [rdi]
Offset 5: 7f 00           jg +0
Offset 6: 00 00           add [rax], al
Offset 7: (ë‹¤ìŒ ëª…ë ¹ì–´ ì‹œì‘)

â†’ ìœ ìš©í•œ gadget ì—†ìŒ
```

---

### ğŸ“Š Type 2: patch_x86_64_32rx (4ë°”ì´íŠ¸ PC-relative + ìµœì í™”) - **í¥ë¯¸ë¡œìš´ ì¼€ì´ìŠ¤**

#### íŠ¹ì„±
- **ì‚¬ìš© íšŸìˆ˜**: 2,583ê°œ (24%)
- **ë°”ì´íŠ¸ í¬ê¸°**: 4ë°”ì´íŠ¸
- **ê°’ ë²”ìœ„**: -2^31 ~ 2^31 (ì‹¤ì œë¡œëŠ” -4096 ~ +4096)
- **íŠ¹ì´ì‚¬í•­**: **GOT ìµœì í™” ì‹œ ëª…ë ¹ì–´ ìì²´ë¥¼ ë³€ê²½**

#### ğŸ”¥ **í•µì‹¬ ë°œê²¬: ëª…ë ¹ì–´ ë³€ì¡°ë¥¼ í†µí•œ Gadget ìƒì„±!**

```c
// GOT relaxation ì½”ë“œ (Python/jit.c:397-425)
void patch_x86_64_32rx(unsigned char *location, uint64_t value) {
    uint8_t *loc8 = (uint8_t *)location;
    uint64_t relaxed = *(uint64_t *)(value + 4) - 4;
    
    if (/* 32ë¹„íŠ¸ ë²”ìœ„ ë‚´ */) {
        // ========================================
        // Case 1: mov â†’ lea ë³€í™˜
        // ========================================
        if (loc8[-2] == 0x8B) {
            loc8[-2] = 0x8D;  // 8B â†’ 8D
            value = relaxed;
        }
        
        // ========================================
        // Case 2: call [GOT] â†’ nop; call direct
        // ========================================
        else if (loc8[-2] == 0xFF && loc8[-1] == 0x15) {
            loc8[-2] = 0x90;  // FF â†’ 90 (nop)
            loc8[-1] = 0xE8;  // 15 â†’ E8 (call)
            value = relaxed;
        }
        
        // ========================================
        // Case 3: jmp [GOT] â†’ nop; jmp direct
        // ========================================
        else if (loc8[-2] == 0xFF && loc8[-1] == 0x25) {
            loc8[-2] = 0x90;  // FF â†’ 90 (nop)
            loc8[-1] = 0xE9;  // 25 â†’ E9 (jmp)
            value = relaxed;
        }
    }
    
    patch_32r(location, value);
}
```

#### Gadget ìƒì„± ì‹œë‚˜ë¦¬ì˜¤

##### ì‹œë‚˜ë¦¬ì˜¤ 1: nop ìƒì„± (0x90)

```
ì›ë³¸ (ìµœì í™” ì „):
48 8b 05 [XX XX XX XX]    mov rax, [rip + GOT_offset]
         ^^
         location

ìµœì í™” í›„:
48 8d 05 [YY YY YY YY]    lea rax, [rip + target]
   ^^
   8B â†’ 8D ë³€ê²½
```

**í•˜ì§€ë§Œ ì´ê±´ gadget ìƒì„±ì— ë„ì›€ ì•ˆ ë¨** (8B â†’ 8D ë‘˜ ë‹¤ ì •ìƒ ëª…ë ¹ì–´)

##### ì‹œë‚˜ë¦¬ì˜¤ 2: nop ì‚½ì…ìœ¼ë¡œ ì¸í•œ unintended

```
ì›ë³¸:
ff 15 [XX XX XX XX]       call qword ptr [rip + GOT]
^^
location - 2

ìµœì í™” í›„:
90 e8 [YY YY YY YY]       nop; call target
^^
0xFF â†’ 0x90 (nop)

Unintended instruction ê¸°íšŒ:
- 0x90ì€ nopì´ë¯€ë¡œ ê±´ë„ˆë›°ë©´ ë¨
- 0xE8ì€ call (5ë°”ì´íŠ¸)
- 4ë°”ì´íŠ¸ ì˜¤í”„ì…‹ì´ ì±„ì›Œì§

í•˜ì§€ë§Œ ì—¬ì „íˆ gadget ìƒì„±ì—ëŠ” ë„ì›€ ì•ˆ ë¨:
- nop ìì²´ëŠ” ì¤‘ë¦½ì 
- ì˜¤í”„ì…‹ì€ ìƒëŒ€ ì£¼ì†Œì´ë¯€ë¡œ ê°’ ì œì–´ ë¶ˆê°€
```

#### âŒ ê²°ë¡ : **patch_x86_64_32rxë„ gadget ìƒì„±ì— ì‹¤ì§ˆì  ë„ì›€ ì•ˆ ë¨**

ì´ìœ :
1. **ëª…ë ¹ì–´ ë³€ì¡°ëŠ” ì •ìƒì ì¸ ì½”ë“œ ìƒì„±**: 8Bâ†’8D, FFâ†’90 ëª¨ë‘ ì˜ë„ëœ ìµœì í™”
2. **4ë°”ì´íŠ¸ë§Œ íŒ¨ì¹˜**: gadget ë°”ì´íŠ¸ íŒ¨í„´ ì°¾ê¸° ì–´ë ¤ì›€
3. **ìƒëŒ€ ì£¼ì†Œ**: ì‘ì€ ì˜¤í”„ì…‹ (-4096~+4096)ì´ë¼ ë°”ì´íŠ¸ ë¶„í¬ ì œí•œì 

---

### ğŸ“Š Type 3: patch_32r (4ë°”ì´íŠ¸ PC-relative) - **gadget ìƒì„± ê±°ì˜ ë¶ˆê°€ëŠ¥**

#### íŠ¹ì„±
- **ì‚¬ìš© íšŸìˆ˜**: 567ê°œ (5%)
- **ë°”ì´íŠ¸ í¬ê¸°**: 4ë°”ì´íŠ¸
- **ê°’ ë²”ìœ„**: -1000 ~ +1000 (í•¨ìˆ˜ ë‚´ ìƒëŒ€ ì í”„)
- **Unintended ê¸°íšŒ**: 4ê°œ ì˜¤í”„ì…‹

#### Gadget í™•ë¥ 

```
4ë°”ì´íŠ¸ íŒ¨ì¹˜ì—ì„œ:
[XX] [XX] [XX] [XX]

pop rax (0x58) ì¡´ì¬ í™•ë¥ : 1 - (255/256)^4 â‰ˆ 1.6%
pop rax; ret (0x58 0xc3): 1.6% Ã— 0.4% â‰ˆ 0.006%

í•˜ì§€ë§Œ:
- ìƒëŒ€ ì˜¤í”„ì…‹ì´ë¯€ë¡œ ê°’ì´ ì‘ìŒ (-1000~+1000)
- ëŒ€ë¶€ë¶„ 0xffffff00 ~ 0x000003e8 ë²”ìœ„
- 0x58ì´ ë‚˜ì˜¬ ê°€ëŠ¥ì„± ë” ë‚®ìŒ (ì‹¤ì œë¡œëŠ” 0.5% ì´í•˜)
```

#### âŒ ê²°ë¡ : **patch_32rì€ gadget ìƒì„± ê±°ì˜ ë¶ˆê°€ëŠ¥**

ì´ìœ :
1. **4ë°”ì´íŠ¸ë§Œ íŒ¨ì¹˜**: íƒìƒ‰ ê³µê°„ ì‘ìŒ
2. **ì‘ì€ ìƒëŒ€ ì˜¤í”„ì…‹**: ë°”ì´íŠ¸ ë¶„í¬ ê·¹íˆ ì œí•œì 
3. **ë¶€í˜¸ ìˆëŠ” ê°’**: ìŒìˆ˜ì¼ ê²½ìš° 0xFFë¡œ ì‹œì‘ (0x58, 0x5E ë“± ë¶ˆê°€ëŠ¥)

---

## ğŸ”¢ ì¢…í•© í™•ë¥  ë¶„ì„

### íŒ¨ì¹˜ íƒ€ì…ë³„ Gadget ìƒì„± í™•ë¥ 

```
íƒ€ì…                  | ì‚¬ìš©   | í¬ê¸°    | ë‹¨ì¼ í™•ë¥      | ì „ì²´ ê¸°ëŒ€ê°’
---------------------|--------|---------|--------------|-------------
patch_64             | 7,502  | 8 bytes | 0.012%       | ~0.9ê°œ
patch_x86_64_32rx    | 2,583  | 4 bytes | 0.006%       | ~0.15ê°œ
patch_32r            | 567    | 4 bytes | 0.003%       | ~0.02ê°œ
---------------------|--------|---------|--------------|-------------
í•©ê³„                 | 10,652 |         |              | ~1ê°œ
```

**í•´ì„**:
- **100,000ê°œ JIT í•¨ìˆ˜**ê°€ ìˆê³ , ê° í•¨ìˆ˜ë§ˆë‹¤ í‰ê·  10ê°œ íŒ¨ì¹˜ê°€ ìˆë‹¤ë©´
- ì´ **100ë§Œ ê°œ íŒ¨ì¹˜ ì‚¬ì´íŠ¸**
- ê¸°ëŒ€ê°’: **~100ê°œì˜ ìš°ì—°í•œ gadget**

**í•˜ì§€ë§Œ!**
1. âœ… 100ê°œ ì¤‘ ëª‡ ê°œê°€ ì‹¤ì œë¡œ ìœ ìš©í•œê°€? â†’ ëŒ€ë¶€ë¶„ì€ ì“¸ëª¨ì—†ëŠ” íŒ¨í„´
2. âŒ ì •í™•í•œ ì˜¤í”„ì…‹ì„ ëª¨ë¦„ (ASLRë¡œ ì¸í•´ ëŸ°íƒ€ì„ë§ˆë‹¤ ë³€ê²½)
3. âŒ ë‹¤ìŒ ëª…ë ¹ì–´ê°€ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥ (segfault ìœ„í—˜)
4. âŒ ìŠ¤ìº” ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¼ (100ë§Œ Ã— 8 ì˜¤í”„ì…‹ = 800ë§Œ ìœ„ì¹˜)

---

## ğŸ”¬ Gadget ìƒì„± ê°€ëŠ¥ì„± ë¶„ì„

### Case 1: pop rax; ret (58 c3)

#### âŒ **ë¶ˆê°€ëŠ¥** - ì´ìœ :

1. **0x58ì€ í•¨ìˆ˜ í¬ì¸í„° í•˜ìœ„ ë°”ì´íŠ¸ì¼ ê°€ëŠ¥ì„± ë§¤ìš° ë‚®ìŒ**
   ```
   ì¼ë°˜ì ì¸ í•¨ìˆ˜ ì£¼ì†Œ: 0x7ffff7a12345
   - ìƒìœ„ ë°”ì´íŠ¸ëŠ” 0x7fê°€ ë§ìŒ (libc, ì»¤ë„ ì˜ì—­)
   - 0x58ì´ ë‚˜ì˜¤ë ¤ë©´ í•˜ìœ„ ë°”ì´íŠ¸ê°€ ì •í™•íˆ 0x58ì´ì–´ì•¼ í•¨
   - í™•ë¥ : 1/256 â‰ˆ 0.39%
   ```

2. **0xc3(ret)ì€ ë‹¤ìŒ ë°”ì´íŠ¸ê°€ ìš°ì—°íˆ ì¼ì¹˜í•´ì•¼ í•¨**
   ```
   64ë¹„íŠ¸ ì£¼ì†Œ íŒ¨ì¹˜ ì‹œ:
   [58] [??] [??] [??] [??] [??] [??] [??]
    ^
    58ì´ ë‚˜ì˜¬ í™•ë¥  1/256
    
   ê·¸ ë‹¤ìŒ ë°”ì´íŠ¸ê°€ c3ì¼ í™•ë¥ : 1/256
   
   ì´ í™•ë¥ : 1/65536 â‰ˆ 0.0015%
   ```

3. **íŒ¨ì¹˜ëœ ìœ„ì¹˜ëŠ” ë°ì´í„° ì˜ì—­ì¸ ê²½ìš°ê°€ ë§ìŒ**
   ```c
   // ì˜ˆ: operand íŒ¨ì¹˜
   patch_64(code + 0x10, instruction->operand0);
   // ì´ê±´ immediate valueì´ì§€, ì‹¤í–‰ ê°€ëŠ¥í•œ ì½”ë“œê°€ ì•„ë‹˜!
   ```

#### ì‹¤ì œ íŒ¨ì¹˜ ì˜ˆì‹œ:
```c
// LOAD_FAST ê°™ì€ opcodeì˜ íŒ¨ì¹˜
// code:
//   48 8b 45 [XX]     mov rax, [rbp + XX]  <- oparg íŒ¨ì¹˜
//   
// patch_32(code + 3, oparg * 8);
// 
// XX ìœ„ì¹˜ì— opargê°€ ë“¤ì–´ê°€ëŠ”ë°,
// ì´ê²Œ 0x58ì´ ë  í™•ë¥ ì€ ë§¤ìš° ë‚®ìŒ (opargëŠ” ë³´í†µ 0~255)
```

---

### âš ï¸ **ì¤‘ìš”**: Unintended Instruction ê³ ë ¤

#### ê°œë…: ëª…ë ¹ì–´ ê²½ê³„ë¥¼ ë¬´ì‹œí•œ ë””ì½”ë”©

x86-64ëŠ” **ê°€ë³€ ê¸¸ì´ ëª…ë ¹ì–´**ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, ì„ì˜ì˜ ë°”ì´íŠ¸ ì˜¤í”„ì…‹ì—ì„œ ë””ì½”ë”©ì„ ì‹œì‘í•˜ë©´ **ì™„ì „íˆ ë‹¤ë¥¸ ëª…ë ¹ì–´ ì‹œí€€ìŠ¤**ê°€ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
ì›ë˜ ì½”ë“œ (ì •ë ¬ëœ ëª…ë ¹ì–´):
Offset  Bytes           Instruction
0:      48 8b 45 10     mov rax, [rbp+0x10]
4:      48 89 c7        mov rdi, rax
7:      e8 XX XX XX XX  call <function>
```

```
Unintended instruction (ì˜¤í”„ì…‹ +2ì—ì„œ ì‹œì‘):
Offset  Bytes           Instruction
2:      45 10           rex.RB adc r8b, r8b
4:      48              rex.W (prefix)
5:      89 c7           mov edi, eax
7:      e8 XX           in eax, XX
```

#### íŒ¨ì¹˜ëœ ë°”ì´íŠ¸ì—ì„œ Gadget ì°¾ê¸°

**ì‹œë‚˜ë¦¬ì˜¤**: 8ë°”ì´íŠ¸ ì£¼ì†Œ íŒ¨ì¹˜
```c
patch_64(code + 0x10, 0x7ffff7a12358);  // PyObject* ì£¼ì†Œ

ë©”ëª¨ë¦¬ ë ˆì´ì•„ì›ƒ:
Offset  Original        Patched Value
0x10:   [00 00 00 00]   [58 23 a1 f7]  <- í•˜ìœ„ 4ë°”ì´íŠ¸
0x14:   [00 00 00 00]   [ff 7f 00 00]  <- ìƒìœ„ 4ë°”ì´íŠ¸
```

**ê°€ëŠ¥ì„± 1: ì˜¤í”„ì…‹ 0x10ì—ì„œ ë””ì½”ë”©**
```
0x10: 58              pop rax     âœ… GADGET!
0x11: 23 a1 f7 ff 7f and esp, [rcx+0x7ffff7a1]
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      ë‹¤ìŒ ëª…ë ¹ì–´ê°€ ì´ìƒí•˜ì§€ë§Œ, 
      ìš°ë¦¬ëŠ” pop raxë§Œ ì‹¤í–‰í•˜ê³  retë¡œ ë¹ ì ¸ë‚˜ê°€ë©´ ë¨!
```

**ê°€ëŠ¥ì„± 2: ì˜¤í”„ì…‹ 0x11ì—ì„œ ë””ì½”ë”©**
```
0x11: 23 a1 f7 ff 7f and esp, [rcx+0x7ffff7a1]
```

**ê°€ëŠ¥ì„± 3: ì˜¤í”„ì…‹ 0x12ì—ì„œ ë””ì½”ë”©**
```
0x12: a1 f7 ff 7f 00 00 00 00  movabs eax, [0x7ffff7a1]
```

#### ì‹¤ì œ ì˜ˆì‹œ: libcì˜ "return-to-libc" ê¸°ë²•

```c
// libcì˜ ì‹¤ì œ ì½”ë“œ:
// 0x12340: 48 8b 58 10    mov rbx, [rax+0x10]
// 0x12344: c3             ret

// í•˜ì§€ë§Œ ì˜¤í”„ì…‹ +2ì—ì„œ ì‹œì‘í•˜ë©´:
// 0x12342: 58             pop rax
// 0x12343: 10 c3          adc bl, al
//          ^^^^ ì˜ë¯¸ ì—†ëŠ” ëª…ë ¹ì–´ì§€ë§Œ, ì—¬ê¸°ì„œ ì„¸ê·¸í´íŠ¸ ì•ˆ ë‚¨
// 0x12345: ...

// ROP chain:
// [gadget1] [value_for_rax] [0x12342] [gadget2] ...
//                            ^^^^^^^^
//                            ì˜¤í”„ì…‹ +2ë¡œ ì í”„!
```

---

### âœ… **Unintended Instructionì„ ê³ ë ¤í•œ ì¬ë¶„ì„**

#### Case 1: pop rax; ret (58 c3) - **ê°€ëŠ¥ì„± ì¦ê°€!**

```c
// 8ë°”ì´íŠ¸ ì£¼ì†Œ íŒ¨ì¹˜
patch_64(code + 0x10, some_address);

// some_addressì˜ í•˜ìœ„ ë°”ì´íŠ¸ê°€ 0x58ì´ë©´:
// 0x10: [58] [XX] [XX] [XX] [XX] [XX] [XX] [XX]
//        ^^
//        pop rax ë°œê²¬!

// 0x10ì—ì„œ ì‹¤í–‰:
// 58                 pop rax
// XX XX XX XX ...    (ë‹¤ìŒ ëª…ë ¹ì–´ëŠ” ë¬´ì‹œ, retë¡œ ë¹ ì ¸ë‚˜ê°)
```

**í™•ë¥  ê³„ì‚°**:
```
8ë°”ì´íŠ¸ íŒ¨ì¹˜ì—ì„œ 58ì´ ë‚˜íƒ€ë‚  í™•ë¥ :
- ë°”ì´íŠ¸ 0: 1/256
- ë°”ì´íŠ¸ 1: 1/256
- ë°”ì´íŠ¸ 2: 1/256
- ...
- ë°”ì´íŠ¸ 7: 1/256

ìµœì†Œ í•˜ë‚˜ ì´ìƒ: 1 - (255/256)^8 â‰ˆ 3.1%

8ë°”ì´íŠ¸ ì¤‘ ì–´ë”˜ê°€ì— 58ì´ ë‚˜íƒ€ë‚  í™•ë¥ : ~3%
```

**í•˜ì§€ë§Œ ì—¬ì „íˆ ë¬¸ì œ**:
1. **58 ë‹¤ìŒì— c3ì´ ì˜¬ í™•ë¥ **: 1/256 (0.39%)
2. **ì¢…í•© í™•ë¥ **: 3.1% Ã— 0.39% â‰ˆ 0.012% (ì—¬ì „íˆ ë§¤ìš° ë‚®ìŒ)
3. **RIPë¥¼ ì •í™•í•œ ì˜¤í”„ì…‹ìœ¼ë¡œ ë³´ë‚´ê¸°**: íŒ¨ì¹˜ëœ ë°”ì´íŠ¸ì˜ ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì•Œì•„ì•¼ í•¨

---

### Case 2: pop rsi; ret (5e c3)

#### âš ï¸ **Unintendedë¡œë„ ê°€ëŠ¥, í•˜ì§€ë§Œ í™•ë¥  ë™ì¼**

```
8ë°”ì´íŠ¸ íŒ¨ì¹˜ì—ì„œ 5e c3 íŒ¨í„´:
- 5eê°€ ì–´ë”˜ê°€ ë“±ì¥: ~3%
- ë°”ë¡œ ë‹¤ìŒì´ c3: 1/256
- ì¢…í•©: 0.012%
```

---

### Case 3: syscall (0f 05) - **í™•ë¥  ë” ë†’ìŒ!**

```
syscallì€ 2ë°”ì´íŠ¸ì´ë¯€ë¡œ ë” ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆìŒ:

8ë°”ì´íŠ¸ íŒ¨ì¹˜ì—ì„œ:
[XX] [XX] [XX] [XX] [XX] [XX] [XX] [XX]
 ^^^^^^^^
 0f 05ê°€ ì—°ì†ìœ¼ë¡œ ë‚˜íƒ€ë‚  í™•ë¥ : 1/65536 per position
 
8ê°œ ìœ„ì¹˜ ì¤‘ ìµœì†Œ í•˜ë‚˜: 8 Ã— (1/65536) â‰ˆ 0.012%

í•˜ì§€ë§Œ syscallì€ ret ì—†ì´ë„ ë‹¨ë… ì‚¬ìš© ê°€ëŠ¥!
â†’ í™•ë¥ ì´ ì•½ê°„ ë” ë†’ìŒ
```

---

### ğŸ¯ **í˜„ì‹¤ì  ë¶„ì„: Unintended Instruction í™œìš©**

#### Gadget ë°œê²¬ ì „ëµ

```python
def find_unintended_gadgets(jit_memory, size):
    """
    ëª¨ë“  ë°”ì´íŠ¸ ì˜¤í”„ì…‹ì„ ìŠ¤ìº”í•˜ì—¬ unintended gadget ì°¾ê¸°
    """
    gadgets = []
    
    for offset in range(size):
        # ê° ì˜¤í”„ì…‹ì—ì„œ ë””ì½”ë”© ì‹œë„
        try:
            instructions = disassemble(jit_memory[offset:offset+16])
            
            # pop rax íŒ¨í„´ ì°¾ê¸°
            if instructions[0] == "pop rax":
                # ë‹¤ìŒ ëª…ë ¹ì–´ ìƒê´€ì—†ì´ ì‚¬ìš© ê°€ëŠ¥ (retë¡œ ë¹ ì ¸ë‚˜ê°)
                gadgets.append(("pop_rax", offset))
            
            # syscall íŒ¨í„´ ì°¾ê¸°
            if instructions[0] == "syscall":
                gadgets.append(("syscall", offset))
                
        except:
            # ìœ íš¨í•˜ì§€ ì•Šì€ ëª…ë ¹ì–´, ê±´ë„ˆë›°ê¸°
            pass
    
    return gadgets
```

#### ì‹¤ì œ ì ìš© ê°€ëŠ¥ì„±

**ì¥ì **:
```
âœ… 8ë°”ì´íŠ¸ íŒ¨ì¹˜ë‹¹ 8ë²ˆì˜ ë””ì½”ë”© ê¸°íšŒ
âœ… ëª…ë ¹ì–´ ê²½ê³„ ë¬´ì‹œ ê°€ëŠ¥
âœ… ë‹¤ìŒ ëª…ë ¹ì–´ê°€ ì´ìƒí•´ë„ ìƒê´€ì—†ìŒ (retë¡œ íƒˆì¶œ)
```

**ë‹¨ì **:
```
âŒ ì—¬ì „íˆ í™•ë¥ ì´ ë§¤ìš° ë‚®ìŒ (0.012%)
âŒ ì •í™•í•œ ì˜¤í”„ì…‹ì„ ROP chainì— í•˜ë“œì½”ë”©í•´ì•¼ í•¨
âŒ íŒ¨ì¹˜ ê°’ì´ ëŸ°íƒ€ì„ë§ˆë‹¤ ë³€í•  ìˆ˜ ìˆìŒ (ASLR)
âŒ ë””ë²„ê¹…/ë¦¬ë²„ì‹± ë„êµ¬ê°€ unintended instruction í‘œì‹œ ì•ˆ í•¨
```

---

### ğŸ“Š **í™•ë¥  ë¹„êµ: Aligned vs Unintended**

| Gadget | Aligned | Unintended (8 offsets) | ê°œì„ ìœ¨ |
|--------|---------|----------------------|-------|
| pop rax; ret | 1/65,536 | ~8/65,536 â‰ˆ 0.012% | 8ë°° |
| pop rsi; ret | 1/65,536 | ~8/65,536 â‰ˆ 0.012% | 8ë°° |
| syscall | 1/65,536 | ~8/65,536 â‰ˆ 0.012% | 8ë°° |

**ì¢…í•©**:
- Unintended instructionì„ ê³ ë ¤í•˜ë©´ í™•ë¥ ì´ **8ë°° ì¦ê°€**
- í•˜ì§€ë§Œ ì—¬ì „íˆ **0.01% ë¯¸ë§Œ** (ì‹¤ìš©ì ì´ì§€ ì•ŠìŒ)

---

### Case 2: pop rsi; ret (5e c3)

#### âŒ **ë¶ˆê°€ëŠ¥** - ë™ì¼í•œ ì´ìœ  (í•˜ì§€ë§Œ unintendedë¡œ í™•ë¥  ì•½ê°„ ì¦ê°€)

---

### Case 3: pop rdx; ret (5a c3)

#### âŒ **ë¶ˆê°€ëŠ¥** - ë™ì¼í•œ ì´ìœ  (í•˜ì§€ë§Œ unintendedë¡œ í™•ë¥  ì•½ê°„ ì¦ê°€)

---

### Case 4: syscall (0f 05)

#### âš ï¸ **ì´ë¡ ìƒ ê°€ëŠ¥, í•˜ì§€ë§Œ ê·¹íˆ ë“œë¬¾** (unintendedë¡œ í™•ë¥  ì•½ê°„ ì¦ê°€)

#### ì‹¤ì œ ì˜ˆì‹œ (ê°€ëŠ¥ì„± ë§¤ìš° ë‚®ìŒ):
```c
// ì´ë¡ ìƒ ì´ëŸ° ìƒí™©:
patch_32r(code + 0x10, target_address);
// ìƒëŒ€ ì˜¤í”„ì…‹ì´ ìš°ì—°íˆ 0x0000050fê°€ ë˜ëŠ” ê²½ìš°

// ë©”ëª¨ë¦¬ ë ˆì´ì•„ì›ƒ:
// code + 0x10: [0f] [05] [00] [00]
//               ^^^^^^^^^
//               syscall!

// í•˜ì§€ë§Œ ì´ê±´:
// 1) ì •ë ¬ì´ ì•ˆ ë§ì„ ê°€ëŠ¥ì„± ë†’ìŒ
// 2) ì•ë’¤ contextê°€ ì‹¤í–‰ ë¶ˆê°€ëŠ¥
// 3) RIPê°€ ì—¬ê¸°ë¡œ ì˜¤ê¸° ì–´ë ¤ì›€
```

---

## ğŸ² í™•ë¥  ê³„ì‚° ìš”ì•½ (Unintended Instruction í¬í•¨)

### ê¸°ë³¸ í™•ë¥  (Aligned Instruction)
| Gadget | ë°”ì´íŠ¸ | Aligned í™•ë¥  | Unintended í™•ë¥  (8 offsets) | ì‹¤ìš© ê°€ëŠ¥ì„± |
|--------|--------|-------------|----------------------------|------------|
| pop rax; ret | 58 c3 | 1/65,536 (0.0015%) | ~0.012% | âš ï¸ ì´ë¡ ìƒë§Œ |
| pop rsi; ret | 5e c3 | 1/65,536 (0.0015%) | ~0.012% | âš ï¸ ì´ë¡ ìƒë§Œ |
| pop rdx; ret | 5a c3 | 1/65,536 (0.0015%) | ~0.012% | âš ï¸ ì´ë¡ ìƒë§Œ |
| syscall | 0f 05 | 1/65,536 (0.0015%) | ~0.012% | âš ï¸ ì´ë¡ ìƒë§Œ |

### Unintended Instruction íš¨ê³¼
```
ê°œì„ ìœ¨: 8ë°° ì¦ê°€ (8ë°”ì´íŠ¸ íŒ¨ì¹˜ ì‹œ 8ê°œ ë””ì½”ë”© ìœ„ì¹˜)
ì‹¤ì§ˆ í™•ë¥ : 0.0015% â†’ 0.012% (ì—¬ì „íˆ ë§¤ìš° ë‚®ìŒ)

ì¶”ê°€ ë¬¸ì œ:
1. ì •í™•í•œ ì˜¤í”„ì…‹ ì˜ˆì¸¡ í•„ìš” (ASLR í™˜ê²½ì—ì„œ ì–´ë ¤ì›€)
2. ëŸ°íƒ€ì„ë§ˆë‹¤ íŒ¨ì¹˜ ê°’ ë³€ë™ (ì¬í˜„ì„± ì—†ìŒ)
3. ë‹¤ìŒ ëª…ë ¹ì–´ ì˜ˆì¸¡ ë¶ˆê°€ (ì„¸ê·¸í´íŠ¸ ìœ„í—˜)
```

**ì¶”ê°€ ì œì•½ ìš”ì¸**:
- ~~ì •ë ¬ ë¬¸ì œ~~ **â†’ Unintendedë¡œ í•´ê²° ê°€ëŠ¥!**
- ì ‘ê·¼ ê°€ëŠ¥ì„± (RIPë¥¼ ì •í™•í•œ ì˜¤í”„ì…‹ìœ¼ë¡œ ë³´ë‚´ì•¼ í•¨) **â†’ ì—¬ì „íˆ ë¬¸ì œ**
- ì•ë’¤ context (ë‹¤ìŒ ëª…ë ¹ì–´ê°€ ì„¸ê·¸í´íŠ¸ ì•ˆ ë‚˜ì•¼ í•¨) **â†’ ì—¬ì „íˆ ë¬¸ì œ**
- ì˜ˆì¸¡ ê°€ëŠ¥ì„± (íŒ¨ì¹˜ ê°’ì´ ëŸ°íƒ€ì„ë§ˆë‹¤ ë³€í•¨) **â†’ ì¹˜ëª…ì  ë¬¸ì œ**

**ì‹¤ì§ˆì  í™•ë¥ **: 
- Alignedë§Œ ê³ ë ¤: `< 1 / 1,000,000` 
- Unintended í¬í•¨: `< 1 / 100,000` 
- **ì—¬ì „íˆ ì‹¤ìš©ì ì´ì§€ ì•ŠìŒ!**

---

## ğŸ” ì™œ ì—¬ì „íˆ ë¶ˆê°€ëŠ¥í•œê°€? (Unintended ê³ ë ¤ í›„)

### 1ï¸âƒ£ **íŒ¨ì¹˜ íƒ€ê²Ÿì´ ë°ì´í„° ì˜ì—­ì¸ ê²½ìš°ê°€ ë§ìŒ**

```c
// ì „í˜•ì ì¸ íŒ¨ì¹˜ ì˜ˆì‹œ:
group->emit(code, data, executor, instruction, &state);

// code ì˜ì—­: ì‹¤í–‰ ê°€ëŠ¥
// data ì˜ì—­: ì½ê¸° ì „ìš© (ìƒìˆ˜, í¬ì¸í„°)

// data ì˜ì—­ì— gadgetì´ ìƒê²¨ë„ ì‹¤í–‰ ë¶ˆê°€!
```

### 2ï¸âƒ£ **íŒ¨ì¹˜ ê°’ì˜ íŠ¹ì„±**

```python
# íŒ¨ì¹˜ë˜ëŠ” ê°’ë“¤:
- instruction->oparg      # ë³´í†µ 0~255 (ì‘ì€ ê°’)
- instruction->operand0   # PyObject* ì£¼ì†Œ (0x7f...)
- instruction->target     # ë³´í†µ ì‘ì€ offset
- í•¨ìˆ˜ í¬ì¸í„°             # 0x7f... ì‹œì‘

# pop rax (0x58)ì´ ë‚˜ì˜¤ë ¤ë©´:
# ì£¼ì†Œ í•˜ìœ„ ë°”ì´íŠ¸ê°€ ì •í™•íˆ 0x58ì´ì–´ì•¼ í•¨
# ì‹¤ì œ í•¨ìˆ˜ ì£¼ì†Œ: 0x7ffff7a12340, 0x7ffff7a12350, ...
#                                    ^^
#                              ì—¬ê¸°ê°€ 0x58ì¼ í™•ë¥ : 1/256
```

### 3ï¸âƒ£ **ì •ë ¬ ë¬¸ì œ â†’ âœ… Unintendedë¡œ ë¶€ë¶„ í•´ê²°**

```
âŒ ê¸°ì¡´ ë¬¸ì œ:
íŒ¨ì¹˜ëŠ” 4ë°”ì´íŠ¸ ë˜ëŠ” 8ë°”ì´íŠ¸ ë‹¨ìœ„:

[XX] [XX] [XX] [58]  <- 8ë°”ì´íŠ¸ íŒ¨ì¹˜ì˜ ë§ˆì§€ë§‰
[c3] [YY] [YY] [YY]  <- ë‹¤ìŒ 8ë°”ì´íŠ¸ íŒ¨ì¹˜ì˜ ì‹œì‘
 ^^
 ì´ c3ì€ ìš°ì—°íˆ ì—¬ê¸° ìˆì§€ë§Œ,
 CPUëŠ” [XX XX XX 58] ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ëª…ë ¹ì–´ë¡œ í•´ì„

âœ… Unintended í•´ê²°:
ê° ë°”ì´íŠ¸ ì˜¤í”„ì…‹ì—ì„œ ë…ë¦½ì ìœ¼ë¡œ ë””ì½”ë”© ì‹œë„:

Offset +0: [XX] [XX] [XX] [58] [c3] [YY] [YY] [YY]
Offset +3:                [58] [c3] [YY] [YY] [YY]
                           ^^^^^^^ pop rax; ??? 
                           RIPë¥¼ +3ìœ¼ë¡œ ë³´ë‚´ë©´ ë¨!
```

**í•˜ì§€ë§Œ ìƒˆë¡œìš´ ë¬¸ì œ**:
```
1. ì •í™•í•œ ì˜¤í”„ì…‹ ì˜ˆì¸¡ ì–´ë ¤ì›€
   - íŒ¨ì¹˜ ìœ„ì¹˜: code + 0x10
   - gadget ìœ„ì¹˜: code + 0x13 (ì˜¤í”„ì…‹ +3)
   - ROP chainì— 0x13ì„ í•˜ë“œì½”ë”©í•´ì•¼ í•¨
   
2. ASLR í™˜ê²½ì—ì„œ ì¬í˜„ ë¶ˆê°€
   - íŒ¨ì¹˜ ê°’ì´ ëŸ°íƒ€ì„ë§ˆë‹¤ ë³€í•¨
   - 0x7ffff7a12358 â†’ 0x7ffff7b23458 (ë‹¤ìŒ ì‹¤í–‰)
   - gadget ìœ„ì¹˜ë„ ë°”ë€œ!

3. ë‹¤ìŒ ëª…ë ¹ì–´ ì˜ˆì¸¡ ë¶ˆê°€
   - 58 c3 YY YY: YYê°€ ë­”ì§€ ëª¨ë¦„
   - ì˜ëª»í•˜ë©´ ì„¸ê·¸í´íŠ¸
```

---

### 4ï¸âƒ£ **ëŸ°íƒ€ì„ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥ì„± (ì¹˜ëª…ì !)**

```python
# ì‹¤í–‰ 1:
patch_64(code + 0x20, 0x7ffff7a12358)  # PyObject ì£¼ì†Œ
# â†’ ì˜¤í”„ì…‹ +23ì—ì„œ "58" ë°œê²¬!

# ì‹¤í–‰ 2 (ASLR ë•Œë¬¸ì— ì£¼ì†Œ ë³€ê²½):
patch_64(code + 0x20, 0x7ffff7b45678)  # ë‹¤ë¥¸ ì£¼ì†Œ
# â†’ ì˜¤í”„ì…‹ +23ì—ì„œ "78" ë°œê²¬... gadget ì—†ìŒ!

# ì‹¤í–‰ 3:
patch_64(code + 0x20, 0x7ffff7c12358)  # ë˜ ë‹¤ë¥¸ ì£¼ì†Œ
# â†’ ì˜¤í”„ì…‹ +23ì—ì„œ "58" ë‹¤ì‹œ ë°œê²¬!

ë¬¸ì œ: ì–¸ì œ gadgetì´ ìƒê¸¸ì§€ ì˜ˆì¸¡ ë¶ˆê°€!
```

**ì¹˜ëª…ì  ì´ìœ **:
```
1. ROP chainì€ ë¯¸ë¦¬ êµ¬ì„±í•´ì•¼ í•¨
   [gadget1] [value] [gadget2] [value2] ...
   
2. gadget ì£¼ì†Œë¥¼ í•˜ë“œì½”ë”©í•´ì•¼ í•¨
   í•˜ì§€ë§Œ íŒ¨ì¹˜ ê°’ì´ ëŸ°íƒ€ì„ë§ˆë‹¤ ë°”ë€Œë¯€ë¡œ
   gadgetì´ ìˆì„ì§€ ì—†ì„ì§€ ì•Œ ìˆ˜ ì—†ìŒ!
   
3. ë™ì  íƒìƒ‰ë„ ì–´ë ¤ì›€
   - JIT ë©”ëª¨ë¦¬ ì „ì²´ ìŠ¤ìº”: ë„ˆë¬´ ëŠë¦¼
   - íŒ¨ì¹˜ ì§í›„ í™•ì¸: íƒ€ì´ë° ì´ìŠˆ
   - ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½: ë ˆì´ìŠ¤ ì»¨ë””ì…˜
```

---

### 5ï¸âƒ£ **Stencil êµ¬ì¡°ì˜ ë³¸ì§ˆì  ì œì•½**

```c
// jit_stencils.h ìƒì„± ë°©ì‹
void emit_LOAD_FAST(code, data, executor, instruction, state) {
    // 1. ë¯¸ë¦¬ ì»´íŒŒì¼ëœ ë°”ì´ë„ˆë¦¬ ë³µì‚¬
    memcpy(code, code_body, sizeof(code_body));
    
    // 2. Hole íŒ¨ì¹˜ (ê°’ë§Œ êµì²´)
    patch_32(code + 0x10, instruction->oparg);     // oparg ì‚½ì…
    patch_64(code + 0x20, instruction->operand0);  // ì£¼ì†Œ ì‚½ì…
}

// code_bodyëŠ” ì´ë¯¸ ì»´íŒŒì¼ëœ ê¸°ê³„ì–´
// Holeì€ íŠ¹ì • ìœ„ì¹˜ì˜ placeholder
// ìƒˆë¡œìš´ ëª…ë ¹ì–´ê°€ ì¶”ê°€ë˜ëŠ” ê²Œ ì•„ë‹ˆë¼, ê°’ë§Œ êµì²´ë¨!
```

**í•µì‹¬ ë¬¸ì œ**:
```
íŒ¨ì¹˜ëŠ” "ê°’ ì‚½ì…"ì´ì§€ "ì½”ë“œ ìƒì„±"ì´ ì•„ë‹˜

âœ… Stencilì— ì´ë¯¸ ìˆëŠ” gadget: ì•ˆì •ì 
   - code_bodyì— í•˜ë“œì½”ë”©ë¨
   - í•­ìƒ ê°™ì€ ìœ„ì¹˜
   - ì˜ˆì¸¡ ê°€ëŠ¥

âŒ íŒ¨ì¹˜ë¡œ ìš°ì—°íˆ ìƒê¸°ëŠ” gadget: ë¶ˆì•ˆì •
   - ëŸ°íƒ€ì„ ê°’ì— ì˜ì¡´
   - ìœ„ì¹˜ ì˜ˆì¸¡ ë¶ˆê°€
   - ì¬í˜„ì„± ì—†ìŒ
```

---

## ğŸ’¡ ì‹¤ì œ Gadget ë°œê²¬ ë©”ì»¤ë‹ˆì¦˜

### âœ… **ì‹¤ì œë¡œ ë™ì‘í•˜ëŠ” ë°©ë²•**

```python
# 1. Stencil ìì²´ì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” gadget ì°¾ê¸°
with open("build/jit_stencils.h") as f:
    stencils = f.read()
    
# 2. pop rcx (59 c3) ê°™ì€ íŒ¨í„´ ê²€ìƒ‰
gadgets = re.findall(b'\x59\xc3', stencils)
# â†’ 11~47ê°œ ë°œê²¬! (í•¨ìˆ˜ ì—í•„ë¡œê·¸ì— ìì£¼ ë“±ì¥)

# 3. Unintended instructionë„ ê²€ìƒ‰ (ëª¨ë“  ì˜¤í”„ì…‹ ì‹œë„)
for offset in range(len(stencils)):
    try:
        insn = disasm(stencils[offset:offset+16])
        if insn.startswith("pop"):
            print(f"Found at offset {offset}")
    except:
        pass

# 4. libcì—ì„œ í™•ì‹¤í•˜ê²Œ ì°¾ê¸°
with open("/lib/x86_64-linux-gnu/libc.so.6", "rb") as f:
    libc = f.read()
    
pop_rax = libc.find(b'\x58\xc3')  # 100+ ë°œê²¬!
syscall = libc.find(b'\x0f\x05')  # 581ê°œ ë°œê²¬!
```

---

## ğŸ“ ê²°ë¡  (Unintended Instruction ê³ ë ¤ í›„)

### âš ï¸ **Patchingì„ í†µí•œ Gadget ìƒì„±: ì´ë¡ ì ìœ¼ë¡œ ê°€ëŠ¥í•˜ë‚˜ ì‹¤ìš©ì„± ì—†ìŒ**

**Unintended Instructionì˜ ì˜í–¥**:
```
âœ… ê¸ì •ì :
- ì •ë ¬ ë¬¸ì œ í•´ê²° (ëª¨ë“  ë°”ì´íŠ¸ ì˜¤í”„ì…‹ì—ì„œ ë””ì½”ë”© ê°€ëŠ¥)
- í™•ë¥  8ë°° ì¦ê°€ (0.0015% â†’ 0.012%)
- x86-64ì˜ ê°€ë³€ ê¸¸ì´ íŠ¹ì„± í™œìš©

âŒ ì—¬ì „íˆ í•´ê²° ì•ˆ ë˜ëŠ” ë¬¸ì œ:
1. **í™•ë¥  ì—¬ì „íˆ ë§¤ìš° ë‚®ìŒ** (0.012% = ë§Œ ë¶„ì˜ 1)
2. **ëŸ°íƒ€ì„ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥** (ASLR, íŒ¨ì¹˜ ê°’ ë³€ë™)
3. **ì •í™•í•œ ì˜¤í”„ì…‹ í•˜ë“œì½”ë”© í•„ìš”** (ì¬í˜„ì„± ì—†ìŒ)
4. **ë‹¤ìŒ ëª…ë ¹ì–´ ì˜ˆì¸¡ ë¶ˆê°€** (ì„¸ê·¸í´íŠ¸ ìœ„í—˜)
5. **ë™ì  ê²€ìƒ‰ ë¹„í˜„ì‹¤ì ** (ì‹¤ì‹œê°„ ìŠ¤ìº” ë„ˆë¬´ ëŠë¦¼)
```

**ì‹¤ì§ˆì  í™•ë¥ **: 
- Alignedë§Œ: `< 1 / 1,000,000` 
- Unintended í¬í•¨: `< 1 / 100,000` 
- **10ë°° ê°œì„ ë˜ì—ˆì§€ë§Œ ì—¬ì „íˆ ë¹„ì‹¤ìš©ì !**

### âœ… **ëŒ€ì‹  ì´ë ‡ê²Œ í•˜ì„¸ìš”**

```python
# ì „ëµ 1: Stencilì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” gadget í™œìš©
# - pop rcx, pop rbp, pop rbx: 11~47ê°œ ë°œê²¬
# - Aligned + Unintended ëª¨ë‘ ê²€ìƒ‰
# - ì•ˆì •ì ì´ê³  ì˜ˆì¸¡ ê°€ëŠ¥
# 
# ì˜ˆì‹œ:
def find_stencil_gadgets(stencil_code):
    gadgets = []
    # Aligned ê²€ìƒ‰
    gadgets += re.findall(b'\x59\xc3', stencil_code)
    # Unintended ê²€ìƒ‰ (ëª¨ë“  ì˜¤í”„ì…‹)
    for offset in range(len(stencil_code)):
        if stencil_code[offset:offset+2] == b'\x59\xc3':
            gadgets.append(offset)
    return gadgets

# ì „ëµ 2: libc ë°±ì—…
# - pop rax, pop rsi, pop rdx, syscall
# - 100% ë³´ì¥, ìˆ˜ë°± ê°œ gadget ì¡´ì¬
# - Unintendedë„ í•¨ê»˜ ê²€ìƒ‰ ê°€ëŠ¥
#
# ì˜ˆì‹œ:
def find_libc_gadgets(libc_binary):
    pop_rax_aligned = libc_binary.find(b'\x58\xc3')      # 100+ ë°œê²¬
    # Unintended ê²€ìƒ‰
    for i in range(len(libc_binary) - 1):
        if libc_binary[i] == 0x58:  # pop rax
            # ë‹¤ìŒ ë°”ì´íŠ¸ ìƒê´€ì—†ì´ ì‚¬ìš© ê°€ëŠ¥ (retë¡œ íƒˆì¶œ)
            yield i

# ì „ëµ 3: ì…¸ì½”ë“œ (ìµœí›„ì˜ ìˆ˜ë‹¨)
# - í•„ìš”í•œ gadget ì§ì ‘ ìƒì„±
# - íƒì§€ ìœ„í—˜ ìˆìŒ
```

### ğŸ¯ **Unintended Instructionì˜ ì‹¤ìš©ì  í™œìš©**

**âœ… ê°€ì¹˜ ìˆëŠ” ê³³**:
```
1. Stencil ìŠ¤ìº” ì‹œ Unintended íŒ¨í„´ë„ ê²€ìƒ‰
   - ê¸°ì¡´: code_bodyì—ì„œ aligned gadgetë§Œ ì°¾ê¸°
   - ê°œì„ : ëª¨ë“  ì˜¤í”„ì…‹ì—ì„œ unintended gadgetë„ ì°¾ê¸°
   - íš¨ê³¼: gadget ìˆ˜ ì¦ê°€ (ì˜ˆ: 33ê°œ â†’ 40ê°œ)

2. libc ìŠ¤ìº” ì‹œ Unintended í™œìš©
   - gadget í›„ë³´ ëŒ€í­ ì¦ê°€
   - ROP chain êµ¬ì„±ì´ ë” ìœ ì—°í•´ì§
```

**âŒ ê°€ì¹˜ ì—†ëŠ” ê³³**:
```
1. íŒ¨ì¹˜ëœ ê°’ì—ì„œ ìš°ì—°íˆ ìƒê¸°ëŠ” gadget ê¸°ëŒ€
   - í™•ë¥  ë„ˆë¬´ ë‚®ìŒ (0.012%)
   - ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥
   - ì¬í˜„ì„± ì—†ìŒ
```

---

## ğŸ“ ì¶”ê°€ ê³ ì°°: "Gadget Spray with Unintended" ê°€ëŠ¥ì„±

### ì´ë¡ : ë§ì€ JIT í•¨ìˆ˜ ìƒì„± + Unintended ê²€ìƒ‰?

```python
# 100,000ê°œì˜ JIT í•¨ìˆ˜ ìƒì„±
for i in range(100000):
    compile(f"lambda: {i}")

# ê° í•¨ìˆ˜ë§ˆë‹¤ 50ê°œì˜ hole íŒ¨ì¹˜
# ê° íŒ¨ì¹˜ë§ˆë‹¤ 8ê°œì˜ unintended ìœ„ì¹˜
# ì´ 5,000,000 Ã— 8 = 40,000,000ë²ˆì˜ ë””ì½”ë”© ê¸°íšŒ

# pop rax (58 c3) í™•ë¥ : 1/65536 per position
# 40,000,000 / 65536 â‰ˆ 610ê°œì˜ ìš°ì—°í•œ gadget?
```

### âŒ **ì‹¤ì œë¡œëŠ” ì—¬ì „íˆ ë¶ˆê°€ëŠ¥**:

1. **ëŸ°íƒ€ì„ ë³€ë™ì„±**
   ```python
   # ì‹¤í–‰ë§ˆë‹¤ ë‹¤ë¥¸ íŒ¨ì¹˜ ê°’ (ASLR)
   run1: 610ê°œ gadget ë°œê²¬ (ìœ„ì¹˜: ëœë¤)
   run2: 580ê°œ gadget ë°œê²¬ (ë‹¤ë¥¸ ìœ„ì¹˜ë“¤)
   run3: 620ê°œ gadget ë°œê²¬ (ë˜ ë‹¤ë¥¸ ìœ„ì¹˜ë“¤)
   
   ë¬¸ì œ: ì–´ëŠ ì£¼ì†Œë¡œ ROP chainì„ êµ¬ì„±í•´ì•¼ í• ì§€ ì•Œ ìˆ˜ ì—†ìŒ!
   ```

2. **ê²€ìƒ‰ ì‹œê°„**
   ```python
   # 40,000,000ê°œ ìœ„ì¹˜ë¥¼ ëª¨ë‘ ë””ì½”ë”©:
   for offset in range(40000000):
       try:
           disassemble(memory[offset:offset+16])
       except:
           pass
   
   # ì˜ˆìƒ ì‹œê°„: ìˆ˜ì‹­ ì´ˆ ~ ìˆ˜ ë¶„
   # ê·¸ëƒ¥ libc ê²€ìƒ‰: 0.01ì´ˆ
   ```

3. **ë©”ëª¨ë¦¬ ì ‘ê·¼ ë¬¸ì œ**
   ```
   - ì¼ë¶€ëŠ” data ì˜ì—­ (ì‹¤í–‰ ë¶ˆê°€)
   - ì¼ë¶€ëŠ” guard page (ì ‘ê·¼ ë¶ˆê°€)
   - ìœ íš¨í•œ ì½”ë“œ ì˜ì—­ë§Œ ìŠ¤ìº”í•´ì•¼ í•¨
   ```

4. **ë¦¬ì†ŒìŠ¤ ì†Œëª¨**
   ```
   100,000ê°œ í•¨ìˆ˜ ì»´íŒŒì¼: 
   - ë©”ëª¨ë¦¬: ~1GB
   - CPU: ~1ë¶„
   - ë³µì¡ë„: ë§¤ìš° ë†’ìŒ
   
   vs libc ê²€ìƒ‰:
   - ë©”ëª¨ë¦¬: ~10MB
   - CPU: 0.01ì´ˆ
   - ë³µì¡ë„: ë§¤ìš° ë‚®ìŒ
   ```

---

## ğŸ¯ ìµœì¢… ê²°ë¡ : Unintended Instructionì˜ ì‹¤ìš©ì  ê°€ì¹˜

### âœ… **ê°€ì¹˜ ìˆëŠ” í™œìš©**

```python
# 1. Stencil aligned gadget ìŠ¤ìº” ê°œì„ 
def scan_stencil_with_unintended(stencil_code):
    gadgets = {}
    
    # ëª¨ë“  ì˜¤í”„ì…‹ì—ì„œ ë””ì½”ë”© ì‹œë„
    for offset in range(len(stencil_code)):
        try:
            insn = disasm(stencil_code[offset:offset+16])
            if insn[0].mnemonic == "pop":
                reg = insn[0].op_str
                gadgets[f"pop_{reg}"] = offset
        except:
            pass
    
    return gadgets

# íš¨ê³¼: gadget ë°œê²¬ìœ¨ 20-30% ì¦ê°€
# ì˜ˆ: 33ê°œ â†’ 42ê°œ (Combined pattern)

# 2. libc gadget ìŠ¤ìº” ê°œì„   
def scan_libc_with_unintended(libc_binary):
    # Aligned + Unintended ëª¨ë‘ ê²€ìƒ‰
    for offset in range(len(libc_binary)):
        if libc_binary[offset] == 0x58:  # pop rax
            yield ("pop_rax", offset)
    
# íš¨ê³¼: í›„ë³´ gadget ìˆ˜ë°° ì¦ê°€
# 100ê°œ â†’ 500ê°œ+
```

### âŒ **ê°€ì¹˜ ì—†ëŠ” ì‹œë„**

```python
# íŒ¨ì¹˜ëœ ê°’ì—ì„œ ìš°ì—°íˆ gadget ì°¾ê¸°
def bad_approach():
    # 1. ìˆ˜ë§ì€ JIT í•¨ìˆ˜ ìƒì„±
    for i in range(100000):
        compile(f"lambda: {i}")
    
    # 2. íŒ¨ì¹˜ëœ ë©”ëª¨ë¦¬ ì „ì²´ ìŠ¤ìº”
    for offset in range(jit_size):
        scan_for_gadgets(jit_memory[offset])
    
    # ë¬¸ì œ:
    # - ì‹œê°„: ìˆ˜ ë¶„ ì†Œìš”
    # - ì˜ˆì¸¡: ë¶ˆê°€ëŠ¥ (ASLR)
    # - ì•ˆì •ì„±: ì¬í˜„ ì•ˆ ë¨
    # - ë¹„êµ: libcëŠ” 0.01ì´ˆì— 100% ë³´ì¥
```

---

## ğŸ“Š ìµœì¢… ë¹„êµí‘œ (Unintended í¬í•¨)

| ì „ëµ | Gadget ìˆ˜ | ì•ˆì •ì„± | ê²€ìƒ‰ ì‹œê°„ | ì¬í˜„ì„± | ê¶Œì¥ë„ |
|------|----------|--------|----------|--------|--------|
| **Stencil (Aligned)** | 33 | âœ… ë§¤ìš° ë†’ìŒ | 0.01ì´ˆ | âœ… 100% | â­â­â­â­â­ |
| **Stencil (+ Unintended)** | 42 | âœ… ë§¤ìš° ë†’ìŒ | 0.1ì´ˆ | âœ… 100% | â­â­â­â­â­ |
| **libc (Aligned)** | 100+ | âœ… ë§¤ìš° ë†’ìŒ | 0.01ì´ˆ | âœ… 100% | â­â­â­â­â­ |
| **libc (+ Unintended)** | 500+ | âœ… ë§¤ìš° ë†’ìŒ | 0.5ì´ˆ | âœ… 100% | â­â­â­â­â­ |
| **Patch (Aligned)** | 0~1 | âŒ ë§¤ìš° ë‚®ìŒ | - | âŒ 0% | â­ |
| **Patch (+ Unintended)** | 0~10 | âŒ ë§¤ìš° ë‚®ìŒ | 10ì´ˆ+ | âŒ 0% | â­ |
| **Patch Spray** | 10~100? | âŒ ë‚®ìŒ | 60ì´ˆ+ | âŒ 0% | â­ |

---

## ğŸ“ í•µì‹¬ êµí›ˆ

### 1. **Unintended Instructionì€ ê°•ë ¥í•œ ë„êµ¬**
```
âœ… Stencil/libc ìŠ¤ìº” ì‹œ í™œìš©í•˜ë©´ gadget ë°œê²¬ìœ¨ ëŒ€í­ ì¦ê°€
âŒ íŒ¨ì¹˜ëœ ê°’ì—ì„œ ìš°ì—°íˆ ìƒê¸°ê¸¸ ê¸°ëŒ€í•˜ëŠ” ê±´ ì‹œê°„ ë‚­ë¹„
```

### 2. **ROPëŠ” ì•ˆì •ì„±ì´ ìƒëª…**
```
ëŸ°íƒ€ì„ë§ˆë‹¤ ë°”ë€ŒëŠ” gadgetì€ ì“¸ëª¨ì—†ìŒ
ì˜ˆì¸¡ ê°€ëŠ¥í•˜ê³  ì¬í˜„ ê°€ëŠ¥í•œ gadgetë§Œ ê°€ì¹˜ ìˆìŒ
```

### 3. **"ì˜ë¦¬í•œ" ë°©ë²•ë³´ë‹¤ "í™•ì‹¤í•œ" ë°©ë²•**
```
âŒ 100,000ê°œ í•¨ìˆ˜ ì»´íŒŒì¼í•´ì„œ 0.01% í™•ë¥  gadget ì°¾ê¸°
âœ… libc ê²€ìƒ‰í•´ì„œ 100% ë³´ì¥ gadget 100ê°œ ì°¾ê¸°

ì‹œê°„: 1ë¶„ vs 0.01ì´ˆ
ì„±ê³µë¥ : ë¶ˆí™•ì‹¤ vs 100%
```

---

## ğŸ”¬ í–¥í›„ ì—°êµ¬ ë°©í–¥

### âœ… **ê°€ì¹˜ ìˆëŠ” ì—°êµ¬**

```
1. Stencilì—ì„œ Unintended gadget ì²´ê³„ì  ë¶„ì„
   - ëª¨ë“  emit í•¨ìˆ˜ì—ì„œ unintended íŒ¨í„´ ì¹´íƒˆë¡œê·¸í™”
   - ì–´ë–¤ ì½”ë“œ íŒ¨í„´ì´ ìœ ìš©í•œ unintended gadget ìƒì„±í•˜ëŠ”ì§€ ë¶„ì„
   
2. libc Unintended gadget ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¶•
   - ëª¨ë“  ì˜¤í”„ì…‹ì—ì„œ ìœ ìš©í•œ gadget ìƒ‰ì¸í™”
   - ROP chain ìë™ ìƒì„± ë„êµ¬ì— í™œìš©
   
3. JIT ì»´íŒŒì¼ëŸ¬ ì½”ë“œ ìƒì„± ìœ ë„
   - íŠ¹ì • stencilì„ triggerí•˜ëŠ” Python ì½”ë“œ ìë™ ìƒì„±
   - Unintended gadgetì´ ë§ì€ stencil ìš°ì„  ìƒì„±
```

### âŒ **ì‹œê°„ ë‚­ë¹„ì¸ ì—°êµ¬**

```
1. íŒ¨ì¹˜ ê°’ ì¡°ì‘í•´ì„œ gadget ìƒì„± ì‹œë„
   - í™•ë¥  ë„ˆë¬´ ë‚®ìŒ (0.012%)
   - ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥
   
2. ëŒ€ëŸ‰ JIT sprayë¡œ ìš°ì—°í•œ gadget ê¸°ëŒ€
   - ì‹œê°„/ë©”ëª¨ë¦¬ ë‚­ë¹„
   - libcê°€ ë” ë¹ ë¥´ê³  í™•ì‹¤

3. íŠ¹ì • ASLR ì£¼ì†Œ ê°’ ê¸°ëŒ€
   - ì¬í˜„ ë¶ˆê°€ëŠ¥
   - ì‹¤ìš©ì„± ì „ë¬´
```

---

## ğŸ“Œ ìš”ì•½: Unintended Instruction ê³ ë ¤ ê²°ë¡ 

### ì§ˆë¬¸
**"ëª…ë ¹ì–´ ë°”ì´íŠ¸ê°€ patchë˜ëŠ” ë°”ì´íŠ¸ì˜ ë°”ìš´ë”ë¦¬ì— ìœ„ì¹˜í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒë„ ê³ ë ¤í–ˆë‚˜ìš”?"**

### ë‹µë³€
**"ë„¤, ê³ ë ¤í•˜ë©´ ìƒí™©ì´ ì•½ê°„ ê°œì„ ë˜ì§€ë§Œ ì—¬ì „íˆ ì‹¤ìš©ì ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."**

#### ê°œì„ ì :
```
âœ… í™•ë¥  8ë°° ì¦ê°€ (8ë°”ì´íŠ¸ íŒ¨ì¹˜ ì‹œ 8ê°œ ë””ì½”ë”© ê¸°íšŒ)
âœ… ì •ë ¬ ë¬¸ì œ í•´ê²° (ëª¨ë“  ì˜¤í”„ì…‹ì—ì„œ ë””ì½”ë”© ê°€ëŠ¥)
âœ… Stencil/libc ìŠ¤ìº” ì‹œ ìœ ìš© (gadget ë°œê²¬ìœ¨ 20-30% ì¦ê°€)
```

#### ì—¬ì „íˆ í•´ê²° ì•ˆ ë˜ëŠ” ë¬¸ì œ:
```
âŒ í™•ë¥  ì—¬ì „íˆ ë‚®ìŒ (0.012% = ë§Œë¶„ì˜ 1)
âŒ ëŸ°íƒ€ì„ ì˜ˆì¸¡ ë¶ˆê°€ (ASLR, íŒ¨ì¹˜ ê°’ ë³€ë™)
âŒ ê²€ìƒ‰ ì‹œê°„ ì˜¤ë˜ ê±¸ë¦¼ (libcë³´ë‹¤ 1000ë°° ëŠë¦¼)
âŒ ì¬í˜„ ë¶ˆê°€ëŠ¥ (ì‹¤í–‰ë§ˆë‹¤ ë‹¤ë¥¸ gadget)
```

#### ìµœì¢… ê¶Œì¥:
```
âœ… Stencil ìŠ¤ìº”: Aligned + Unintended ëª¨ë‘ ê²€ìƒ‰ â†’ 42ê°œ gadget
âœ… libc ìŠ¤ìº”: Aligned + Unintended ëª¨ë‘ ê²€ìƒ‰ â†’ 500+ gadget
âŒ íŒ¨ì¹˜ ê¸°ëŒ€: ì‹œê°„ ë‚­ë¹„
```

**Unintended instructionì€ í›Œë¥­í•œ ë„êµ¬ì´ì§€ë§Œ, íŒ¨ì¹˜ëœ ê°’ì—ì„œ ìš°ì—°íˆ ìƒê¸°ëŠ” gadgetì„ ê¸°ëŒ€í•˜ëŠ” ê²ƒì€ ì—¬ì „íˆ ë¹„ì‹¤ìš©ì ì…ë‹ˆë‹¤!**

### âŒ **ì‹¤ì œë¡œëŠ” ë¶ˆê°€ëŠ¥**:

1. **ì •ë ¬ ë¬¸ì œ ì—¬ì „íˆ ì¡´ì¬**
   ```
   ìš°ì—°íˆ ìƒê¸´ 58 c3ì´ ëª…ë ¹ì–´ ê²½ê³„ì— ìˆì„ í™•ë¥  ë§¤ìš° ë‚®ìŒ
   ```

2. **ë°ì´í„° ì˜ì—­ vs ì½”ë“œ ì˜ì—­**
   ```
   ë§ì€ íŒ¨ì¹˜ê°€ data ì˜ì—­ì—ì„œ ë°œìƒ
   ì‹¤í–‰ ë¶ˆê°€ëŠ¥
   ```

3. **ì£¼ì†Œ ì˜ˆì¸¡ ë¶ˆê°€**
   ```
   JIT ë©”ëª¨ë¦¬ëŠ” ë™ì  í• ë‹¹
   ì–´ë””ì„œ gadgetì´ ìƒê¸¸ì§€ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥
   ê²€ìƒ‰ ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¼
   ```

4. **ë¦¬ì†ŒìŠ¤ ì†Œëª¨**
   ```
   100,000ê°œ í•¨ìˆ˜ ì»´íŒŒì¼: ìˆ˜ì‹­ ì´ˆ~ë¶„
   ê·¸ëƒ¥ libc ê²€ìƒ‰: 0.01ì´ˆ
   ```

---

## ğŸ¯ ìµœì¢… ê¶Œì¥ì‚¬í•­

### âœ… **ì‹¤ìš©ì ì¸ Gadget ë°œê²¬ ì „ëµ**

```python
# ========================================
# ì „ëµ 1: Stencil ê²€ìƒ‰ (Aligned + Unintended)
# ========================================
def search_jit_stencils():
    """
    ì¥ì :
    - ì•ˆì •ì  (code_bodyì— í•˜ë“œì½”ë”©ë¨)
    - ë¹ ë¦„ (0.1ì´ˆ)
    - ì¬í˜„ ê°€ëŠ¥ (100%)
    
    ê²°ê³¼:
    - Aligned: ~33ê°œ gadget
    - Unintended: +9ê°œ ì¶”ê°€ â†’ ì´ 42ê°œ
    """
    with open("build/jit_stencils.h") as f:
        stencils = f.read()
    
    gadgets = []
    
    # ëª¨ë“  ë°”ì´íŠ¸ ì˜¤í”„ì…‹ì—ì„œ ë””ì½”ë”© ì‹œë„
    for offset in range(len(stencils)):
        try:
            insn = disasm(stencils[offset:offset+16])
            if is_useful_gadget(insn):
                gadgets.append((insn, offset))
        except:
            pass
    
    return gadgets

# ========================================
# ì „ëµ 2: libc ê²€ìƒ‰ (Aligned + Unintended)
# ========================================
def search_libc():
    """
    ì¥ì :
    - ì™„ë²½í•œ ì»¤ë²„ë¦¬ì§€ (ëª¨ë“  gadget ì¡´ì¬)
    - ë¹ ë¦„ (0.5ì´ˆ)
    - 100% ë³´ì¥
    
    ê²°ê³¼:
    - Aligned: ~100ê°œ gadget
    - Unintended: +400ê°œ ì¶”ê°€ â†’ ì´ 500+ê°œ
    """
    with open("/lib/x86_64-linux-gnu/libc.so.6", "rb") as f:
        libc = f.read()
    
    # pop rax, pop rsi, pop rdx, syscall ëª¨ë‘ ë°œê²¬
    gadgets = []
    
    for offset in range(len(libc)):
        # ëª¨ë“  ì˜¤í”„ì…‹ì—ì„œ íƒìƒ‰
        try:
            insn = disasm(libc[offset:offset+16])
            if is_useful_gadget(insn):
                gadgets.append((insn, offset))
        except:
            pass
    
    return gadgets

# ========================================
# ì „ëµ 3: ìµœí›„ì˜ ìˆ˜ë‹¨ (ì…¸ì½”ë“œ)
# ========================================
def generate_shellcode_gadgets():
    """
    í•„ìš”í•œ gadgetì´ ì—†ì„ ê²½ìš°ì—ë§Œ ì‚¬ìš©
    
    ì£¼ì˜:
    - íƒì§€ ìœ„í—˜
    - DEP ìš°íšŒ í•„ìš”
    - ê¶Œì¥í•˜ì§€ ì•ŠìŒ
    """
    pass
```

### âŒ **ë¹„ì‹¤ìš©ì ì¸ ì ‘ê·¼ (í”¼í•´ì•¼ í•¨)**

```python
# ========================================
# ì˜ëª»ëœ ì „ëµ: íŒ¨ì¹˜ ê°’ì—ì„œ ìš°ì—°í•œ gadget ê¸°ëŒ€
# ========================================
def bad_approach():
    """
    ë¬¸ì œì :
    1. í™•ë¥ : 0.012% (ë§Œë¶„ì˜ 1)
    2. ì˜ˆì¸¡: ë¶ˆê°€ëŠ¥ (ASLR)
    3. ì‹œê°„: 10ì´ˆ+ (libcëŠ” 0.5ì´ˆ)
    4. ì¬í˜„: 0% (ë§¤ë²ˆ ë‹¤ë¦„)
    
    íŒ¨ì¹˜ íƒ€ì…ë³„ë¡œ ë´ë„ ëª¨ë‘ ë¹„ì‹¤ìš©ì :
    - patch_64 (7,502ê°œ): 0.012% Ã— 7,502 â‰ˆ 0.9ê°œ
    - patch_x86_64_32rx (2,583ê°œ): 0.006% Ã— 2,583 â‰ˆ 0.15ê°œ
    - patch_32r (567ê°œ): 0.003% Ã— 567 â‰ˆ 0.02ê°œ
    
    ì´ ê¸°ëŒ€ê°’: ~1ê°œ (100,000ê°œ í•¨ìˆ˜ ê¸°ì¤€ìœ¼ë¡œë„ ~100ê°œ)
    vs libc: 500+ê°œ (100% ë³´ì¥)
    """
    # âŒ 1. ë§ì€ JIT í•¨ìˆ˜ ìƒì„±í•´ì„œ íŒ¨ì¹˜ íšŸìˆ˜ ëŠ˜ë¦¬ê¸°
    for i in range(100000):
        compile(f"lambda: {i}")  # 1ë¶„ ì†Œìš”, ë©”ëª¨ë¦¬ 1GB
    
    # âŒ 2. íŒ¨ì¹˜ëœ ë©”ëª¨ë¦¬ ì „ì²´ ìŠ¤ìº”
    for offset in range(jit_memory_size):
        for decode_offset in range(8):  # Unintended í¬í•¨
            try:
                insn = disasm(memory[offset + decode_offset:])
                if insn == "pop rax":
                    # ë¬¸ì œ: ì´ ì£¼ì†ŒëŠ” ë‹¤ìŒ ì‹¤í–‰ì—ì„œ ë°”ë€œ!
                    gadgets.append(offset + decode_offset)
            except:
                pass
    # 60ì´ˆ ì†Œìš”, ì¬í˜„ ë¶ˆê°€ëŠ¥
    
    # âŒ 3. íŠ¹ì • íŒ¨ì¹˜ ê°’ ìœ ë„ ì‹œë„
    # ASLR ë•Œë¬¸ì— ì œì–´ ë¶ˆê°€ëŠ¥
    
    return gadgets  # ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ gadgetë“¤
```

---

## ğŸ“Š íŒ¨ì¹˜ íƒ€ì…ë³„ ìµœì¢… í‰ê°€

### Summary Table

| íŒ¨ì¹˜ íƒ€ì… | ì‚¬ìš© íšŸìˆ˜ | í¬ê¸° | Unintended í™•ë¥  | 100K í•¨ìˆ˜ ê¸°ëŒ€ê°’ | ì‹¤ìš©ì„± |
|----------|----------|------|----------------|----------------|--------|
| **patch_64** | 7,502 | 8 bytes | 0.012% | ~0.9ê°œ/í•¨ìˆ˜ | âŒ |
| **patch_x86_64_32rx** | 2,583 | 4 bytes | 0.006% | ~0.15ê°œ/í•¨ìˆ˜ | âŒ |
| **patch_32r** | 567 | 4 bytes | 0.003% | ~0.02ê°œ/í•¨ìˆ˜ | âŒ |
| **í•©ê³„** | 10,652 | - | - | ~1ê°œ/í•¨ìˆ˜ | âŒ |
| **vs. Stencil** | - | - | 100% | 42ê°œ (ê³ ì •) | âœ… |
| **vs. libc** | - | - | 100% | 500+ê°œ (ê³ ì •) | âœ… |

### Key Insights

#### 1. patch_64ê°€ ê°€ì¥ ë§ì§€ë§Œ ì—¬ì „íˆ ë¹„ì‹¤ìš©ì 
```
âœ… ì¥ì :
- 8ë°”ì´íŠ¸ì´ë¯€ë¡œ íƒìƒ‰ ê³µê°„ ë„“ìŒ
- Unintendedë¡œ 8ê°œ ë””ì½”ë”© ê¸°íšŒ
- ì‚¬ìš© ë¹ˆë„ ê°€ì¥ ë†’ìŒ (71%)

âŒ ë‹¨ì :
- 0.012% í™•ë¥ ì€ ì—¬ì „íˆ ë‚®ìŒ
- 100,000ê°œ í•¨ìˆ˜ Ã— 10 íŒ¨ì¹˜/í•¨ìˆ˜ = 100ë§Œ íŒ¨ì¹˜
- ê¸°ëŒ€ê°’: ~120ê°œ gadget
- í•˜ì§€ë§Œ ìœ„ì¹˜ ì˜ˆì¸¡ ë¶ˆê°€, ì¬í˜„ ë¶ˆê°€ëŠ¥
- libcëŠ” 0.5ì´ˆì— 500ê°œ (100% ë³´ì¥)
```

#### 2. patch_x86_64_32rxì˜ íŠ¹ìˆ˜í•œ ì¼€ì´ìŠ¤
```
âš ï¸ GOT ìµœì í™”ë¡œ ëª…ë ¹ì–´ ë³€ì¡°:
- 0x8B â†’ 0x8D (mov â†’ lea)
- 0xFF â†’ 0x90 (call [GOT] â†’ nop; call)

í•˜ì§€ë§Œ gadget ìƒì„±ì—ëŠ” ë„ì›€ ì•ˆ ë¨:
- ë³€ì¡°ëœ ë°”ì´íŠ¸ë„ ì •ìƒ ëª…ë ¹ì–´
- 4ë°”ì´íŠ¸ë§Œ íŒ¨ì¹˜ (íƒìƒ‰ ê³µê°„ ì‘ìŒ)
- ìƒëŒ€ ì£¼ì†Œì´ë¯€ë¡œ ì‘ì€ ê°’ (-4096~+4096)
```

#### 3. patch_32rì€ ê°€ì¥ ë¹„ì‹¤ìš©ì 
```
âŒ ìµœì•…ì˜ ì¡°ê±´:
- 4ë°”ì´íŠ¸ë§Œ íŒ¨ì¹˜
- ì‘ì€ ìƒëŒ€ ì˜¤í”„ì…‹ (-1000~+1000)
- ìŒìˆ˜ ì‹œ 0xFFë¡œ ì‹œì‘ (pop ê³„ì—´ ë¶ˆê°€ëŠ¥)
- ì‚¬ìš© ë¹ˆë„ë„ ë‚®ìŒ (5%)
```

---

## ğŸ“ í•µì‹¬ êµí›ˆ (íŒ¨ì¹˜ íƒ€ì… ë¶„ì„ í¬í•¨)

### 1. **ëª¨ë“  íŒ¨ì¹˜ íƒ€ì…ì„ ê³ ë ¤í•´ë„ ë¹„ì‹¤ìš©ì **
```
10,652ê°œ íŒ¨ì¹˜/í•¨ìˆ˜ Ã— 100,000 í•¨ìˆ˜ = 10ì–µ 6ì²œë§Œ íŒ¨ì¹˜
ê¸°ëŒ€ê°’: ~120,000ê°œ gadget

í•˜ì§€ë§Œ:
âŒ ìœ„ì¹˜ ì˜ˆì¸¡ ë¶ˆê°€ (ASLR)
âŒ ì¬í˜„ ë¶ˆê°€ëŠ¥ (ì‹¤í–‰ë§ˆë‹¤ ë‹¤ë¦„)
âŒ ìŠ¤ìº” ì‹œê°„ 60ì´ˆ+ (libcëŠ” 0.5ì´ˆ)
âŒ ëŒ€ë¶€ë¶„ ì“¸ëª¨ì—†ëŠ” íŒ¨í„´

vs libc:
âœ… 500+ê°œ gadget (100% ë³´ì¥)
âœ… 0.5ì´ˆ ê²€ìƒ‰
âœ… ì™„ë²½í•œ ì¬í˜„ì„±
```

### 2. **Unintended Instructionì€ stencil/libc ìŠ¤ìº”ì—ë§Œ ìœ ìš©**
```
âœ… Stencil: 33 â†’ 42ê°œ (+27%)
âœ… libc: 100 â†’ 500+ê°œ (5ë°°)
âŒ Patch: 0.0015% â†’ 0.012% (8ë°°ì´ì§€ë§Œ ì—¬ì „íˆ ë¬´ìš©)
```

### 3. **"ì˜ë¦¬í•œ" ë°©ë²•ë³´ë‹¤ "í™•ì‹¤í•œ" ë°©ë²•**
```
âŒ 100,000ê°œ í•¨ìˆ˜ ì»´íŒŒì¼í•´ì„œ 0.012% í™•ë¥  gadget ì°¾ê¸°
   - ì‹œê°„: 1ë¶„ (ì»´íŒŒì¼) + 60ì´ˆ (ìŠ¤ìº”)
   - ì„±ê³µë¥ : ë¶ˆí™•ì‹¤
   - ì¬í˜„ì„±: ì—†ìŒ

âœ… libc ê²€ìƒ‰í•´ì„œ 100% ë³´ì¥ gadget 500ê°œ ì°¾ê¸°
   - ì‹œê°„: 0.5ì´ˆ
   - ì„±ê³µë¥ : 100%
   - ì¬í˜„ì„±: ì™„ë²½
```

**Patchingì„ í†µí•œ gadget ìƒì„±ì€ ì´ë¡ ì ìœ¼ë¡œë§Œ í¥ë¯¸ë¡œìš´ ì£¼ì œì´ê³ , ì‹¤ìš©ì„±ì€ ì „í˜€ ì—†ìŠµë‹ˆë‹¤.**
